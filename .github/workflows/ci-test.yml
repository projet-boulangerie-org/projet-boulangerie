name: CI - Test Branches

# Se d√©clenche sur les push vers test-push et les PR vers test-pr
on:
  push:
    branches:
      - test-push
  pull_request:
    branches:
      - test-pr
  workflow_dispatch:  # Permet aussi le d√©clenchement manuel

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # Job 1: Build & Lint basique (comme dev-to-release)
  quick-validation:
    name: Quick Build & Lint
    runs-on: ubuntu-latest
    outputs:
      critical: ${{ steps.npm-audit-test.outputs.critical }}
      high: ${{ steps.npm-audit-test.outputs.high }}
      moderate: ${{ steps.npm-audit-test.outputs.moderate }}
      low: ${{ steps.npm-audit-test.outputs.low }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Next.js
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Build static site
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: Check bundle size
        run: |
          echo "üì¶ Build output size:"
          du -sh out/
          echo ""
          echo "Top 10 plus gros fichiers:"
          find out -type f -exec ls -lh {} \; | sort -k5 -hr | head -10

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-build
          path: out/
          retention-days: 2

  # Job 2: Security checks (version all√©g√©e de release-to-main)
  security-check:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: quick-validation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Next.js
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - name: Install dependencies
        run: npm ci

      # npm audit (non bloquant pour test - informatif)
      - name: npm audit (TEST - Informatif)
        id: npm-audit-test
        run: |
          echo "üîç npm audit (test branch - non bloquant)..."
          echo "üìã Information: Les seuils seront appliqu√©s sur release/main"
          echo ""
          
          # Capturer la sortie de npm audit
          set +e
          AUDIT_OUTPUT=$(npm audit --json 2>&1)
          AUDIT_EXIT=$?
          set -e
          
          # Parser les r√©sultats JSON
          CRITICAL=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")
          HIGH=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")
          MODERATE=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.moderate // 0' 2>/dev/null || echo "0")
          LOW=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.low // 0' 2>/dev/null || echo "0")
          
          # Export vers output pour le summary
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          
          echo "üìä R√©sultats du scan:"
          echo "- Critical severity vulnerabilities: $CRITICAL"
          echo "- High severity vulnerabilities: $HIGH"
          echo "- Moderate severity vulnerabilities: $MODERATE"
          echo "- Low severity vulnerabilities: $LOW"
          echo ""
          
          TOTAL=$((CRITICAL + HIGH + MODERATE + LOW))
          
          if [ $TOTAL -gt 0 ]; then
            echo "‚ÑπÔ∏è  $TOTAL vuln√©rabilit√©(s) d√©tect√©e(s) - Non bloquant pour test"
            echo ""
            echo "üìå Rappel des seuils pour les branches suivantes:"
            echo "  - dev ‚Üí release: 0 critical, 0 high, <5 moderate, <10 low"
            echo "  - release ‚Üí main: 0 vuln√©rabilit√©s (toutes criticit√©s)"
            echo ""
            
            if [ $CRITICAL -gt 0 ] || [ $HIGH -gt 0 ]; then
              echo "‚ö†Ô∏è  Attention: Vuln√©rabilit√©s critical/high pr√©sentes!"
              echo "   ‚Üí Seront BLOQUANTES sur dev‚Üírelease"
            fi
          else
            echo "‚úÖ Aucune vuln√©rabilit√© d√©tect√©e"
          fi
        continue-on-error: true

      # Trivy scan
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Non bloquant pour test
        continue-on-error: true

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      # Secrets scanning - DevSecOps adapt√© √† la taille du projet
      - name: Scan for secrets & sensitive files
        run: |
          echo "üîç DevSecOps Security Scan..."
          echo ""

          FOUND=0

          # 1. Fichiers sensibles qui ne devraient JAMAIS √™tre commit√©s
          echo "üìÅ Recherche de fichiers sensibles..."
          SENSITIVE_FILES=$(find . -type f \( \
            -name "*.pem" -o \
            -name "*.key" -o \
            -name "*.p12" -o \
            -name "*.pfx" -o \
            -name "*password*" -o \
            -name "*secret*" -o \
            -name "*credential*" -o \
            -name ".env" -o \
            -name ".env.local" -o \
            -name ".env.production" \
          \) -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/out/*" 2>/dev/null)

          if [ ! -z "$SENSITIVE_FILES" ]; then
            echo "‚ö†Ô∏è Fichiers sensibles d√©tect√©s:"
            echo "$SENSITIVE_FILES"
            FOUND=1
          else
            echo "‚úÖ Pas de fichiers sensibles"
          fi
          echo ""

          # 2. Secrets hardcod√©s dans le code (patterns communs)
          echo "üîê Recherche de secrets hardcod√©s..."

          # API Keys (format typique: 20-50 caract√®res alphanum√©riques)
          if grep -r -E "(api[_-]?key|apikey)\s*[=:]\s*['\"][a-zA-Z0-9_-]{15,}['\"]" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null; then
            echo "‚ö†Ô∏è API key potentielle d√©tect√©e"
            grep -rn -E "(api[_-]?key|apikey)\s*[=:]\s*['\"][a-zA-Z0-9_-]{15,}['\"]" \
              app/ components/ lib/ \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
              2>/dev/null | head -5
            FOUND=1
          fi

          # Tokens (GitHub, JWT, etc.)
          if grep -r -E "(token|bearer|auth)\s*[=:]\s*['\"][a-zA-Z0-9_-]{20,}['\"]" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null; then
            echo "‚ö†Ô∏è Token potentiel d√©tect√©"
            grep -rn -E "(token|bearer|auth)\s*[=:]\s*['\"][a-zA-Z0-9_-]{20,}['\"]" \
              app/ components/ lib/ \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
              2>/dev/null | head -5
            FOUND=1
          fi

          # Passwords hardcod√©s
          if grep -r -E "(password|passwd|pwd)\s*[=:]\s*['\"][^'\"]{3,}['\"]" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null; then
            echo "‚ö†Ô∏è Password hardcod√© d√©tect√©"
            grep -rn -E "(password|passwd|pwd)\s*[=:]\s*['\"][^'\"]{3,}['\"]" \
              app/ components/ lib/ \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
              2>/dev/null | head -5
            FOUND=1
          fi

          # Private keys
          if grep -r "BEGIN.*PRIVATE KEY" . \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.txt" --include="*.pem" \
            -not -path "*/node_modules/*" -not -path "*/.git/*" \
            2>/dev/null; then
            echo "‚ö†Ô∏è Private key d√©tect√©e"
            grep -rn "BEGIN.*PRIVATE KEY" . \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.txt" --include="*.pem" \
              -not -path "*/node_modules/*" -not -path "*/.git/*" \
              2>/dev/null
            FOUND=1
          fi

          if [ $FOUND -eq 0 ]; then
            echo "‚úÖ Pas de secrets hardcod√©s d√©tect√©s"
          fi
          echo ""

          # 3. URLs/endpoints sensibles (best practice: utiliser variables d'env)
          echo "üåê V√©rification des URLs hardcod√©es..."
          HARDCODED_URLS=$(grep -r -E "(https?://[a-zA-Z0-9.-]+\.(com|net|org|io))" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null | \
            grep -v "github.com" | \
            grep -v "nextjs.org" | \
            grep -v "vercel.com" | \
            grep -v "localhost" | \
            grep -v "example.com" | \
            wc -l)

          if [ "$HARDCODED_URLS" -gt 0 ]; then
            echo "‚ÑπÔ∏è  $HARDCODED_URLS URL(s) hardcod√©e(s) trouv√©e(s)"
            echo "   Conseil: Utiliser des variables d'environnement pour les URLs d'API"
          else
            echo "‚úÖ Pas d'URLs sensibles hardcod√©es"
          fi
          echo ""

          # R√©sum√© final
          if [ $FOUND -eq 1 ]; then
            echo "‚ö†Ô∏è  SECRETS/FICHIERS SENSIBLES D√âTECT√âS"
            echo "   ‚Üí Non bloquant pour test-push, mais √† corriger avant production"
          else
            echo "‚úÖ Scan de s√©curit√© DevSecOps OK"
          fi

  # Job 3: Tests complets (comme release-to-main mais non bloquant)
  full-validation:
    name: Full Production-like Validation
    runs-on: ubuntu-latest
    needs: quick-validation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Next.js
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - name: Install dependencies
        run: npm ci

      - name: Verify package-lock integrity
        run: |
          echo "üîç V√©rification package-lock.json..."
          npm install --package-lock-only
          if ! git diff --exit-code package-lock.json; then
            echo "‚ö†Ô∏è package-lock.json modifi√©"
          else
            echo "‚úÖ package-lock.json OK"
          fi
        continue-on-error: true

      - name: Run ESLint (strict - 0 warnings)
        run: npm run lint -- --max-warnings 0
        continue-on-error: true

      - name: ESLint Security Plugin
        run: |
          npm install --no-save eslint-plugin-security

          cat > eslint.security.config.mjs << 'EOF'
          import security from 'eslint-plugin-security';

          export default [
            {
              ignores: ["node_modules/**", ".next/**", "out/**"]
            },
            {
              files: ["**/*.{js,jsx,ts,tsx}"],
              plugins: {
                security
              },
              rules: {
                'security/detect-object-injection': 'error',
                'security/detect-non-literal-regexp': 'warn',
                'security/detect-unsafe-regex': 'error',
                'security/detect-buffer-noassert': 'error',
                'security/detect-child-process': 'error',
                'security/detect-eval-with-expression': 'error',
                'security/detect-non-literal-fs-filename': 'warn',
                'security/detect-possible-timing-attacks': 'warn',
                'security/detect-pseudoRandomBytes': 'error'
              }
            }
          ];
          EOF

          npx eslint . --config eslint.security.config.mjs --ext .js,.jsx,.ts,.tsx || echo "‚ö†Ô∏è ESLint security warnings"
        continue-on-error: true

      - name: Check for console statements
        run: |
          echo "üîç Recherche de console.log..."
          if grep -r "console\.\(log\|debug\|info\)" app/ components/ lib/ --include="*.tsx" --include="*.ts" 2>/dev/null; then
            echo "‚ö†Ô∏è console.log d√©tect√©s"
          else
            echo "‚úÖ Pas de console.log"
          fi

      - name: Check for dangerous React patterns
        run: |
          echo "üîç Recherche de patterns React dangereux..."
          if grep -r "dangerouslySetInnerHTML" app/ components/ --include="*.tsx" 2>/dev/null; then
            echo "‚ö†Ô∏è dangerouslySetInnerHTML d√©tect√©"
            grep -rn "dangerouslySetInnerHTML" app/ components/ --include="*.tsx"
          else
            echo "‚úÖ Pas de patterns dangereux"
          fi

      - name: Build production
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

  # Job 4: R√©sum√© des tests
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [quick-validation, security-check]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# üß™ Test Branch CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üìä Vuln√©rabilit√©s npm audit:" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical severity vulnerabilities:** ${{ needs.quick-validation.outputs.critical || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **High severity vulnerabilities:** ${{ needs.quick-validation.outputs.high || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Moderate severity vulnerabilities:** ${{ needs.quick-validation.outputs.moderate || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Low severity vulnerabilities:** ${{ needs.quick-validation.outputs.low || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ÑπÔ∏è _Non bloquant pour test-push_" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Jobs Status:" >> $GITHUB_STEP_SUMMARY
          echo "- Quick Validation: ${{ needs.quick-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Check: ${{ needs.security-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚ö° Cache optimis√© avec actions/cache" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Next.js cache automatique (.next/cache/)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ npm cache automatique (node_modules/)" >> $GITHUB_STEP_SUMMARY
          echo "- üöÄ Builds jusqu'√† 5-10x plus rapides !" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üí° Tips:" >> $GITHUB_STEP_SUMMARY
          echo "- Ajoutez \`[full-test]\` dans votre message de commit pour lancer les tests complets" >> $GITHUB_STEP_SUMMARY
          echo "- Les tests sont non-bloquants pour faciliter le d√©veloppement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìå Seuils pour les prochaines branches:" >> $GITHUB_STEP_SUMMARY
          echo "- **dev ‚Üí release:** 0 critical, 0 high, <5 moderate, <10 low" >> $GITHUB_STEP_SUMMARY
          echo "- **release ‚Üí main:** 0 vuln√©rabilit√© (toutes criticit√©s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.quick-validation.result }}" = "success" ] && [ "${{ needs.security-check.result }}" = "success" ]; then
            echo "‚úÖ **All checks passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Some checks failed - review the logs**" >> $GITHUB_STEP_SUMMARY
          fi
